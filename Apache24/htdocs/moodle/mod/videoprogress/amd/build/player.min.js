define("mod_videoprogress/player",["jquery","core/ajax","core/notification"],function(i,a,e){var d={cmid:0,videoid:0,videotype:"youtube",videourl:"",externalurl:"",duration:0,lastposition:0,completionpercent:80,requirefocus:!1,externalmintime:60},s=null,u=0,l=null,c=!1,m=function(){b("createYouTubePlayer called via existing iframe"),s=new YT.Player("videoprogress-youtube-player",{playerVars:{autoplay:0,controls:1,rel:0,modestbranding:1},events:{onReady:t,onStateChange:r}})},t=function(e){b("YouTube Player Ready!");e=Math.floor(e.target.getDuration());b("getDuration() returned: "+e),0<e?(d.duration=e,b("Duration set to: "+d.duration)):b("Duration is 0, will try again when playing"),v()},r=function(e){var t;b("YouTube State Change: "+e.data),e.data===YT.PlayerState.PLAYING?(b("Video Playing"),0===d.duration&&s&&s.getDuration&&0<(t=Math.floor(s.getDuration()))&&(d.duration=t,b("Duration obtained during playback: "+d.duration)),u=Math.floor(s.getCurrentTime())):e.data===YT.PlayerState.PAUSED?g(!1):e.data===YT.PlayerState.ENDED&&(b("Video ENDED - forcing 100% completion"),y(d.duration))},v=function(){setInterval(function(){o()&&(g(!1),u=Math.floor(p()))},5e3)},o=function(){return"youtube"===d.videotype&&s&&s.getPlayerState?s.getPlayerState()===YT.PlayerState.PLAYING:"upload"===d.videotype&&s&&s.element?!s.element.paused:"external"===d.videotype&&"visible"===document.visibilityState&&c},p=function(){var e;return"youtube"===d.videotype&&s&&s.getCurrentTime||"upload"===d.videotype&&s?Math.floor(s.getCurrentTime()):"external"===d.videotype&&l&&c?(e=Math.floor((Date.now()-l)/1e3),u+e):0},g=function(e){var t=p();if(!(t<=u)){var r=d.duration;if(b("DEBUG: Initial videoDuration="+r+", config.duration="+d.duration),0===r){var o=document.getElementById("videoprogress-html5-player");if(o&&o.duration&&0<o.duration&&!isNaN(o.duration)&&(r=Math.floor(o.duration),d.duration=r,b("Duration from HTML5 element: "+r)),0===r&&s&&s.element&&s.element.duration&&0<(n=s.element.duration)&&!isNaN(n)&&(r=Math.floor(n),d.duration=r,b("Duration from player.element: "+r)),0===r&&s&&s.getDuration)try{(n=s.getDuration())&&0<n&&!isNaN(n)&&(r=Math.floor(n),d.duration=r,b("Duration from player.getDuration(): "+r))}catch(e){b("Error getting duration: "+e)}b("Final videoDuration="+r)}var n,o={cmid:d.cmid,segmentstart:u,segmentend:t,currentposition:t,videoduration:r};b("Saving progress: start="+u+", end="+t+", duration="+r),e?((n=new XMLHttpRequest).open("POST",M.cfg.wwwroot+"/lib/ajax/service.php?sesskey="+M.cfg.sesskey,!1),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify([{index:0,methodname:"mod_videoprogress_save_progress",args:o}]))):a.call([{methodname:"mod_videoprogress_save_progress",args:o,done:function(e){b("Save success. Response: "+JSON.stringify(e)),e.completed?f(e.percentcomplete,!0):f(e.percentcomplete,!1)},fail:function(e){b("Save FAILED: "+JSON.stringify(e))}}]),b("Progress saved. Time: "+t)}},y=function(e){var t={cmid:d.cmid,segmentstart:u,segmentend:e,currentposition:e,videoduration:d.duration};b("Saving progress with forced end: start="+u+", end="+e),a.call([{methodname:"mod_videoprogress_save_progress",args:t,done:function(e){b("Save success. Percent: "+e.percentcomplete+"%"),f(100,!0)},fail:function(e){b("Save FAILED: "+JSON.stringify(e))}}])},f=function(e,t){var r=i(".videoprogress-status .progress .progress-bar");b("updateProgressUI called: percent="+e+", completed="+t+", found="+r.length),r.css("width",e+"%").text(e+"%"),t&&(r.removeClass("bg-primary").addClass("bg-success"),e="Completed",M.str&&M.str.mod_videoprogress&&M.str.mod_videoprogress.completed&&(e=M.str.mod_videoprogress.completed),i(".videoprogress-status .badge").removeClass("badge-secondary bg-secondary").addClass("badge-success bg-success").text(e),b("Activity marked as completed!"))},b=function(e){};return{init:function(e){var t,r,o,n,a;b("Init called with type: "+e.videotype),"youtube"===(d=i.extend(d,e)).videotype?(window.YT||((e=document.createElement("script")).src="https://www.youtube.com/iframe_api",(t=document.getElementsByTagName("script")[0]).parentNode.insertBefore(e,t)),window.onYouTubeIframeAPIReady=function(){m()},window.YT&&window.YT.Player&&m()):"external"===d.videotype?(b("initExternalTracking called, externalurl="+d.externalurl),d.externalurl&&0===d.duration&&(d.externalurl.toLowerCase().match(/\.(mp4|webm|ogg|ogv|mov|m4v)(\?|$)/i)?(b("External URL is a direct video file, trying to detect duration..."),(r=document.createElement("video")).style.display="none",r.preload="metadata",r.addEventListener("loadedmetadata",function(){var e=Math.floor(r.duration);b("External video duration detected: "+e),0<e&&(d.duration=e,g(!1)),document.body.removeChild(r)}),r.addEventListener("error",function(){b("Failed to load external video for duration detection"),document.body.removeChild(r)}),document.body.appendChild(r),r.src=d.externalurl):b("External URL is not a direct video file, duration must be set manually")),u=0,c=!1,o=document.getElementById("videoprogress-external-iframe"),window.addEventListener("blur",function(){var e;document.activeElement===o&&!c&&(c=!0,l=Date.now(),b("External timer started by iframe click"),e=document.getElementById("videoprogress-timer-hint"))&&(e.className="alert alert-success mt-2",e.innerHTML='<i class="fa fa-check"></i> '+(M.str&&M.str.mod_videoprogress&&M.str.mod_videoprogress.timerstarted?M.str.mod_videoprogress.timerstarted:"Timer started"))}),setInterval(function(){"visible"===document.visibilityState&&c&&g(!1)},5e3),document.addEventListener("visibilitychange",function(){var e;"hidden"===document.visibilityState?c&&(p(),g(!1),u=0,c=!1,l=null,(e=document.getElementById("videoprogress-external-iframe"))&&(e.setAttribute("data-saved-src",e.src),e.src="about:blank",e.setAttribute("data-needs-overlay","true")),b("External timer paused due to tab switch, next segmentStart="+u)):(e=document.getElementById("videoprogress-external-iframe"))&&"true"===e.getAttribute("data-needs-overlay")&&((e=document.getElementById("videoprogress-overlay"))&&(e.style.display="flex"),e=document.getElementById("videoprogress-timer-hint"))&&(e.className="alert alert-danger mb-2",e.innerHTML='<i class="fa fa-pause"></i> '+(M.str&&M.str.mod_videoprogress&&M.str.mod_videoprogress.timerpaused?M.str.mod_videoprogress.timerpaused:"Timer paused, click the video to continue"))}),(n=document.getElementById("videoprogress-overlay"))&&n.addEventListener("click",function(){var e=document.getElementById("videoprogress-external-iframe"),t=(e&&((t=e.getAttribute("data-saved-src"))&&e.src!==t&&(e.src=t),e.removeAttribute("data-needs-overlay")),n.style.display="none",c=!0,l=Date.now(),document.getElementById("videoprogress-timer-hint"));t&&(t.className="alert alert-success mb-2",t.innerHTML='<i class="fa fa-check"></i> '+(M.str&&M.str.mod_videoprogress&&M.str.mod_videoprogress.timerstarted?M.str.mod_videoprogress.timerstarted:"Timer started")),b("External timer resumed by overlay click")})):(a=document.getElementById("videoprogress-html5-player"),b("initHTML5Player called"),a?(b("HTML5 video element found"),s={element:a,getCurrentTime:function(){return a.currentTime},seekTo:function(e){a.currentTime=e},getDuration:function(){return a.duration}},a.addEventListener("loadedmetadata",function(){var e=Math.floor(a.duration);b("HTML5 loadedmetadata: duration="+e+", current config.duration="+d.duration),0<e&&(d.duration=e,b("HTML5 duration FORCED to: "+d.duration)),v()}),1<=a.readyState&&(e=Math.floor(a.duration),b("HTML5 video already loaded: duration="+e),0===d.duration&&0<e&&(d.duration=e),v()),a.addEventListener("play",function(){b("HTML5 play event, currentTime="+a.currentTime),u=Math.floor(a.currentTime),0===d.duration&&0<a.duration&&(d.duration=Math.floor(a.duration),b("HTML5 duration obtained on play: "+d.duration))}),a.addEventListener("pause",function(){b("HTML5 pause event"),g(!1)}),a.addEventListener("ended",function(){b("HTML5 Video ENDED - forcing 100% completion"),y(d.duration)}),a.addEventListener("timeupdate",function(){var e=Math.floor(a.currentTime);5<=e-u&&(g(!1),u=e)})):b("ERROR: HTML5 video element not found!")),i("#videoprogress-resume-btn").on("click",function(){var e=d.lastposition;"youtube"===d.videotype&&s&&s.seekTo?s.seekTo(e,!0):"upload"===d.videotype&&s&&s.seekTo(e),i("#videoprogress-resume-prompt").fadeOut()}),i(window).on("beforeunload",function(){g(!0)}),!d.requirefocus||"youtube"!==d.videotype&&"upload"!==d.videotype||document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&("youtube"===d.videotype&&s&&s.pauseVideo?s.pauseVideo():s&&s.element&&s.element.pause())})}}});